<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Cookbook — Master–Detail (Editable + Auto-Sync + Videos)</title>
<style>
  :root{--bg:#0f1115;--panel:#12151c;--card:#171a21;--text:#e9edf1;--muted:#9aa7b6;--accent:#4da3ff;--line:#262b35}
  *{box-sizing:border-box} body{margin:0;font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  .container{max-width:1200px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:26px}
  .badge{border:1px solid var(--line);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  button,input,textarea,select{background:var(--panel);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  button{cursor:pointer} button.primary{background:var(--accent);border-color:var(--accent);color:#04111e;font-weight:600}
  button.ghost{background:transparent}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
  .tab{padding:10px;border:1px solid var(--line);border-radius:12px;text-align:center;cursor:pointer;color:var(--muted)}
  .tab.active{background:var(--panel);color:var(--text);border-color:#334}
  .main{display:grid;grid-template-columns:300px 1fr;gap:16px;min-height:60vh}
  .sidebar{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .side-head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
  .search{flex:1}
  .list{overflow:auto}
  .item{display:flex;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer;align-items:center}
  .item:hover{background:#121620}
  .item .title{font-weight:600}
  .item .meta{font-size:12px;color:var(--muted)}
  .item.active{background:#10141d}
  .detail{background:var(--card);border:1px solid var(--line);border-radius:14px}
  .detail-h{padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .detail-title{margin:0;font-size:22px}
  .detail-meta{color:var(--muted);font-size:13px;display:flex;gap:12px;align-items:center}
  .detail-c{padding:16px;display:grid;gap:18px;grid-template-columns:1fr 1fr}
  .section h3{margin:0 0 8px 0;font-size:16px}
  ul,ol{margin:0;padding-left:22px}
  li{margin:8px 0}
  label.chk{display:flex;align-items:flex-start;gap:8px;cursor:pointer}
  .muted{text-decoration:line-through;color:var(--muted)}
  .butter{border:1px solid #2a3550;padding:2px 6px;border-radius:999px;font-size:12px;color:#beddff}
  .empty{border:1px dashed var(--line);padding:24px;border-radius:12px;text-align:center;color:var(--muted)}
  dialog{border:none;border-radius:16px;background:var(--card);color:var(--text);width:min(900px,calc(100% - 32px))}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .grow{width:100%}
  .small{font-size:12px;color:var(--muted)}
  @media (max-width:900px){.main{grid-template-columns:1fr}.detail-c{grid-template-columns:1fr}.sidebar{order:2}}
  @media print{header,.tabs,.toolbar,dialog,.sidebar{display:none} body{background:#fff;color:#000} .detail{background:#fff;border-color:#ccc;box-shadow:none}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="display:flex;align-items:center;gap:10px">
      <h1>My Cookbook</h1>
      <span class="badge">Sidebar list → Full-width • Add/Edit • Checklists • Butter→TBSP • Timers • Auto-Sync • Videos</span>
    </div>
    <div class="toolbar">
      <button id="btn-import">Import JSON</button>
      <button id="btn-export">Export JSON</button>
      <button id="btn-sync">Sync</button>
      <button class="primary" id="btn-add">Add recipe</button>
    </div>
  </header>
  <div class="tabs" id="tabs"></div>
  <div class="main">
    <aside class="sidebar">
      <div class="side-head">
        <select id="catSelect"></select>
        <input id="search" class="search" placeholder="Search in category…" />
      </div>
      <div id="list" class="list"></div>
    </aside>
    <section id="detail" class="detail">
      <div class="empty">Pick a recipe on the left to view it full-width.</div>
    </section>
  </div>
</div>

<!-- Sync dialog (GitHub Gist) -->
<dialog id="sync">
  <form method="dialog" id="sync-form">
    <div style="padding:16px 16px 0 16px;display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Sync recipes (GitHub Gist)</h3>
      <button class="ghost" value="cancel">Close</button>
    </div>
    <div style="padding:16px" class="grid2">
      <div style="grid-column:1/-1" class="small">Create a GitHub token with <b>gist</b> permission (fine-grained token is OK). Stored locally on this device.</div>
      <div><label class="small">GitHub Token (gist scope)</label><input id="gh-token" class="grow" placeholder="ghp_…" /></div>
      <div><label class="small">Gist ID (optional if creating new)</label><input id="gh-gist" class="grow" placeholder="e.g. a1b2c3d4…" /></div>
      <div style="grid-column:1/-1;display:flex;flex-wrap:wrap;gap:8px">
        <button id="btn-gist-create" type="button">Create private gist from current</button>
        <button id="btn-gist-save"   type="button">Save (push) to gist</button>
        <button id="btn-gist-load"   type="button">Load (replace local)</button>
        <button id="btn-gist-merge"  type="button">Merge from gist</button>
        <button id="btn-sync-signout" type="button">Sign out of sync on this device</button>
      </div>
      <div id="sync-status" class="small" style="grid-column:1/-1;color:#beddff"></div>
    </div>
  </form>
</dialog>

<!-- Editor dialog (Add/Edit recipe) -->
<dialog id="editor">
  <form method="dialog" id="editor-form">
    <div style="padding:16px 16px 0 16px;display:flex;justify-content:space-between;align-items:center">
      <h3 id="editor-title" style="margin:0">Add a recipe</h3>
      <button class="ghost" value="cancel">Close</button>
    </div>
    <div style="padding:16px" class="grid2">
      <div><label class="small">Title</label><input id="e-title" class="grow" placeholder="Chocolate Chip Cookies" /></div>
      <div><label class="small">Category</label><input id="e-category" class="grow" placeholder="Breakfast / Lunch / Dinner / Sweets" /></div>
      <div><label class="small">Serves</label><input id="e-serves" class="grow" placeholder="4" /></div>
      <div><label class="small">Total time</label><input id="e-time" class="grow" placeholder="45 min" /></div>
      <div><label class="small">Ingredients (one per line)</label>
        <textarea id="e-ings" rows="8" class="grow" placeholder="1/2 cup butter&#10;2 eggs&#10;1 tsp salt"></textarea></div>
      <div><label class="small">Steps (one per line)</label>
        <textarea id="e-steps" rows="8" class="grow" placeholder="Preheat oven to 350°F&#10;Stir 3 min until glossy&#10;Bake 10-12 min"></textarea></div>
      <!-- NEW: video links -->
      <div style="grid-column:1/-1">
        <label class="small">Video links (one per line — YouTube, TikTok, Vimeo)</label>
        <textarea id="e-videos" rows="4" class="grow" placeholder="https://www.youtube.com/watch?v=XXXXXXX&#10;https://www.tiktok.com/@user/video/1234567890"></textarea>
      </div>
      <div style="grid-column:1/-1">
        <label class="small">Quick paste (optional)</label>
        <textarea id="e-paste" rows="6" class="grow" placeholder="Paste any recipe text here; the parser will try to split into Ingredients and Steps."></textarea>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button id="btn-parse" type="button">Try to parse</button>
          <button id="btn-save" class="primary" value="default">Save recipe</button>
        </div>
      </div>
    </div>
  </form>
</dialog>

<script>
/* ==== Config for auto-load from GitHub ==== */
const GITHUB_JSON_URL =
  "https://raw.githubusercontent.com/jeanfuemmeler-jf/cookbook/main/recipes.json";

/* ====== State & utils ====== */
const DEFAULT_CATEGORIES=["Breakfast","Lunch","Dinner","Sweets"];
const byId=id=>document.getElementById(id);
const $tabs=byId('tabs'),$list=byId('list'),$detail=byId('detail'),$editor=byId('editor');
let RECIPES=JSON.parse(localStorage.getItem('cookbook.recipes')||'[]');
let TAB=localStorage.getItem('cookbook.tab')||'Dinner';
let SELECTED=localStorage.getItem('cookbook.sel')||'';
let EDITING_ID=null; // null = adding; string = editing existing id
// sync settings (optional Gist)
let GH_TOKEN = localStorage.getItem('cookbook.gh.token') || '';
let GH_GIST  = localStorage.getItem('cookbook.gh.gist')  || '';

const norm=s=>String(s||"").trim();
const sameCat=(a,b)=>norm(a).toLowerCase()===norm(b).toLowerCase();
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}

/* ====== Conversions & timers ====== */
function toTbsp(amount, unit){const u=unit.toLowerCase(); if(u.includes('tbsp')||u==='tbs'||u==='tbl')return{tbsp:amount}; if(u.includes('tsp'))return{tbsp:amount/3}; if(u.includes('cup'))return{tbsp:amount*16}; if(u.includes('stick'))return{tbsp:amount*8}; if(u.includes('g'))return{tbsp:amount/14.2,approx:true}; if(u.includes('oz'))return{tbsp:amount*2,approx:true}; return null}
function parseAmount(text){const t=String(text).trim(); if(!t)return null; let m=t.match(/^(\d+)\s+(\d+)\/(\d+)$/); if(m){const w=+m[1],n=+m[2],d=+m[3]; if(d)return w+n/d} m=t.match(/^(\d+)\/(\d+)$/); if(m){const n=+m[1],d=+m[2]; if(d)return n/d} const num=Number(t); return Number.isFinite(num)?num:null}
function butterBadge(line){const s=String(line).toLowerCase(); if(!/\bbutter\b/.test(s))return''; const m=s.match(/(\d+\s+\d+\/\d+|\d+\/\d+|\d+(?:\.\d+)?)\s*(cups?|sticks?|tbsp|tbs|tbl|teaspoons?|tsp|grams?|g|oz)\b/); if(!m)return''; const amt=parseAmount(m[1]); if(amt==null)return''; const conv=toTbsp(amt,m[2]); if(!conv)return''; const tbsp=Math.round(conv.tbsp*100)/100; const approx=conv.approx?' ~':''; return `<span class="butter">${tbsp} tbsp${approx}</span>`}
function parseStirSeconds(text){const m=String(text).toLowerCase().match(/stir[^\d]*(\d+(?:\.\d+)?)\s*(min|mins|minutes|sec|secs|seconds)\b/); if(!m)return 0; const val=parseFloat(m[1]); const unit=m[2]; return /min/.test(unit)?Math.round(val*60):Math.round(val)}
function mmss(s){const m=Math.floor(s/60),sec=s%60; return `${m}:${String(sec).padStart(2,'0')}`}

/* ====== Video helpers (YouTube + TikTok + Vimeo) ====== */
function parseVideoIdYouTube(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if (u.hostname.includes('youtube.com')) {
      if (u.searchParams.get('v')) return u.searchParams.get('v');
      const m = u.pathname.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
      if (m) return m[1];
    }
  } catch {}
  return null;
}
function parseVideoIdVimeo(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes('vimeo.com')) {
      const m = u.pathname.match(/\/(\d+)/);
      if (m) return m[1];
    }
  } catch {}
  return null;
}
function isTikTok(url){
  try{ const u=new URL(url); return u.hostname.includes('tiktok.com'); }catch{return false;}
}
function ensureTikTokScript(){
  if(document.querySelector('script[data-tiktok-embed]')) return;
  const s=document.createElement('script');
  s.src='https://www.tiktok.com/embed.js';
  s.async=true;
  s.setAttribute('data-tiktok-embed','true');
  document.body.appendChild(s);
}
function renderVideoEmbed(url) {
  const yt = parseVideoIdYouTube(url);
  if (yt) {
    const src = `https://www.youtube.com/embed/${yt}`;
    return `<div style="aspect-ratio:16/9"><iframe src="${src}" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width:100%;height:100%;border:0;border-radius:12px"></iframe></div>`;
  }
  if (isTikTok(url)) {
    // TikTok: blockquote + embed script will transform it
    const safe = escapeHtml(url);
    return `<blockquote class="tiktok-embed" cite="${safe}" data-video-id="" style="max-width:605px;min-width:325px;margin:0">
              <section><a href="${safe}" target="_blank" rel="noopener">View on TikTok</a></section>
            </blockquote>`;
  }
  const vm = parseVideoIdVimeo(url);
  if (vm) {
    const src = `https://player.vimeo.com/video/${vm}`;
    return `<div style="aspect-ratio:16/9"><iframe src="${src}" title="Vimeo video" allow="fullscreen; picture-in-picture" allowfullscreen style="width:100%;height:100%;border:0;border-radius:12px"></iframe></div>`;
  }
  // Fallback: plain link
  return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">Open video</a>`;
}

/* ====== Renderers ====== */
function renderTabs(){
  const cats=[...new Set([...DEFAULT_CATEGORIES,...RECIPES.map(r=>norm(r.category))])].filter(Boolean);
  $tabs.innerHTML=cats.map(c=>`<div class="tab ${sameCat(TAB,c)?'active':''}" data-tab="${c}">${c}</div>`).join('');
  const $sel=byId('catSelect');
  $sel.innerHTML=cats.map(c=>`<option value="${c}" ${sameCat(TAB,c)?'selected':''}>${c}</option>`).join('');
}
function renderList(){
  const q=(byId('search').value||'').toLowerCase();
  const list=RECIPES.filter(r=>sameCat(r.category,TAB)&&(!q||(r.title||'').toLowerCase().includes(q)));
  if(!list.length){$list.innerHTML=`<div class="empty">No recipes in ${TAB}. Add one!</div>`;return;}
  $list.innerHTML=list.map(r=>`<div class="item ${SELECTED===r.id?'active':''}" data-id="${r.id}"><div><div class="title">${escapeHtml(r.title)}</div><div class="meta">${escapeHtml(r.serves||'')}${r.serves&&r.time?' · ':''}${escapeHtml(r.time||'')}</div></div></div>`).join('');
}
function renderDetail(){
  if(!SELECTED){$detail.innerHTML='<div class="empty">Pick a recipe on the left to view it full-width.</div>';return;}
  const r=RECIPES.find(x=>x.id===SELECTED);
  if(!r){$detail.innerHTML='<div class="empty">Recipe not found.</div>';return;}
  const ings=(r.ingredients||[]).map((line,i)=>`${checkboxLine('ing',i,line)} ${butterBadge(line)}`).join('');
  const steps=(r.steps||[]).map((line,i)=>{
    const sec=parseStirSeconds(line);
    const timer=sec?`<button type="button" class="ghost" data-timer data-seconds="${sec}">Start</button>`:'';
    // auto-embed video if a link is inside the step
    const urlMatch = String(line).match(/https?:\/\/\S+/);
    let embed = '';
    if (urlMatch) embed = `<div style="margin-top:8px">${renderVideoEmbed(urlMatch[0])}</div>`;
    return `${checkboxLine('step',i,line)} ${timer} ${embed}`;
  }).join('');
  const videos = (r.videos || []).map(u => `<li>${renderVideoEmbed(u)}</li>`).join('');
  const metaParts=[]; if(r.serves) metaParts.push(`Serves: ${escapeHtml(r.serves)}`); if(r.time) metaParts.push(`Total time: ${escapeHtml(r.time)}`);
  $detail.innerHTML=`
    <div class="detail-h">
      <div>
        <h2 class="detail-title">${escapeHtml(r.title)}</h2>
        <div class="detail-meta">${metaParts.join(' · ')} <span class="badge">${escapeHtml(r.category||'')}</span></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="ghost" id="btn-edit">Edit</button>
        <button class="ghost" id="btn-add-video">Add video</button>
        <button class="ghost" id="btn-clear">I'm done</button>
        <button class="ghost" id="btn-del">Delete</button>
      </div>
    </div>
    <div class="detail-c">
      <div class="section"><h3>Ingredient checklist</h3><ul>${ings}</ul></div>
      <div class="section"><h3>Steps</h3><ol>${steps}</ol></div>
      ${(r.videos && r.videos.length)
        ? `<div class="section" style="grid-column:1/-1">
             <h3>Videos</h3>
             <ul style="list-style:none;padding-left:0">${videos}</ul>
           </div>`
        : ''
      }
    </div>`;
  // delete
  byId('btn-del').addEventListener('click',async()=>{ RECIPES=RECIPES.filter(x=>x.id!==r.id); persist(); SELECTED=''; localStorage.setItem('cookbook.sel', SELECTED); renderTabs(); renderList(); renderDetail(); await autoPush(); });
  // edit
  byId('btn-edit').addEventListener('click',()=>openEditor(r));
  // add video (prompt)
  byId('btn-add-video').addEventListener('click', async () => {
    const url = prompt('Paste a YouTube/TikTok/Vimeo link:');
    if (!url) return;
    const updated = { ...r, videos: [...(r.videos || []), url.trim()], updatedAt: new Date().toISOString() };
    RECIPES = RECIPES.map(x => x.id === r.id ? updated : x);
    persist();
    renderDetail();
    // ensure TikTok script is attached if needed
    if (isTikTok(url)) ensureTikTokScript();
    await autoPush();
  });
  // clear all checkboxes
  const clearBtn = byId('btn-clear');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      $detail.querySelectorAll('input[type="checkbox"][data-ing], input[type="checkbox"][data-step]').forEach(cb => {
        cb.checked = false;
        const span = cb.nextElementSibling;
        if (span) span.classList.remove('muted');
      });
    });
  }
  // checkbox strike-through
  $detail.querySelectorAll('[data-ing]').forEach(cb=>{ cb.addEventListener('change',()=>{ cb.nextElementSibling.classList.toggle('muted', cb.checked); }); });
  $detail.querySelectorAll('[data-step]').forEach(cb=>{ cb.addEventListener('change',()=>{ cb.nextElementSibling.classList.toggle('muted', cb.checked); }); });
  // timers
  $detail.querySelectorAll('[data-timer]').forEach(btn=>{ let timer=null, left=+btn.dataset.seconds; const setTxt=()=>btn.textContent=`Stir ${mmss(left)}`; if(left>0){ setTxt(); btn.addEventListener('click',()=>{ if(timer){ clearInterval(timer); timer=null; btn.textContent='Resume'; } else { btn.textContent='Pause'; timer=setInterval(()=>{ if(left>0){ left--; setTxt(); } else { clearInterval(timer); timer=null; btn.textContent='Done'; } },1000); } }); } });
  // if any TikTok embeds present, load script
  if ($detail.querySelector('.tiktok-embed')) ensureTikTokScript();
}
function checkboxLine(kind, i, text){
  return `<li><label class="chk"><input type="checkbox" data-${kind} data-index="${i}"><span>${escapeHtml(text)}</span></label></li>`;
}

/* ====== Editor (Add/Edit) ====== */
function openEditor(recipe){
  EDITING_ID = recipe? recipe.id : null;
  byId('editor-title').textContent = EDITING_ID ? 'Edit recipe' : 'Add a recipe';
  byId('e-title').value = recipe? recipe.title : '';
  byId('e-category').value = recipe? recipe.category : TAB;
  byId('e-serves').value = recipe? (recipe.serves||'') : '';
  byId('e-time').value = recipe? (recipe.time||'') : '';
  byId('e-ings').value = recipe? (recipe.ingredients||[]).join('\n') : '';
  byId('e-steps').value = recipe? (recipe.steps||[]).join('\n') : '';
  byId('e-videos').value = recipe ? (recipe.videos || []).join('\n') : '';
  byId('e-paste').value = '';
  $editor.showModal();
}
async function saveRecipe(){
  const now = new Date().toISOString();
  const data={
    id: EDITING_ID || uid(),
    title: byId('e-title').value||'Untitled',
    category: byId('e-category').value||TAB,
    serves: byId('e-serves').value||'',
    time: byId('e-time').value||'',
    ingredients: byId('e-ings').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
    steps: byId('e-steps').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
    videos: (byId('e-videos').value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
    updatedAt: now
  };
  if(EDITING_ID){ RECIPES = RECIPES.map(r => r.id===EDITING_ID ? data : r); }
  else { RECIPES = [data, ...RECIPES]; }
  persist();
  TAB = data.category; localStorage.setItem('cookbook.tab', TAB);
  SELECTED = data.id; localStorage.setItem('cookbook.sel', SELECTED);
  $editor.close();
  renderTabs(); renderList(); renderDetail();
  await autoPush();
}
function tryParse(){
  const blob=byId('e-paste').value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  if(!blob.length) return;
  const ingI=blob.findIndex(l=>/ingredients?/i.test(l));
  const stepI=blob.findIndex(l=>/(instructions|directions|method|steps)/i.test(l));
  let ings=[],steps=[];
  if(ingI!==-1 && stepI!==-1){ ings=blob.slice(ingI+1, stepI); steps=blob.slice(stepI+1); }
  else if(ingI!==-1){ ings=blob.slice(ingI+1); }
  else if(stepI!==-1){ steps=blob.slice(stepI+1); }
  else { const half=Math.ceil(blob.length/2); ings=blob.slice(0,half); steps=blob.slice(half); }
  if(!byId('e-title').value) byId('e-title').value = blob[0];
  byId('e-ings').value = ings.join('\n');
  byId('e-steps').value = steps.join('\n');
}

/* ====== Persistence ====== */
function persist(){ localStorage.setItem('cookbook.recipes', JSON.stringify(RECIPES)); }

/* ====== Import/Export ====== */
byId('btn-import').addEventListener('click',()=>{ const txt=prompt('Paste JSON exported from here'); if(!txt) return; try{ const arr=JSON.parse(txt); if(Array.isArray(arr)){ RECIPES=arr; persist(); SELECTED=''; localStorage.setItem('cookbook.sel', SELECTED); renderTabs(); renderList(); renderDetail(); } } catch{ alert("Couldn't parse JSON"); } });
byId('btn-export').addEventListener('click',()=>{ const out=JSON.stringify(RECIPES,null,2); const blob=new Blob([out],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='recipes.json'; a.click(); URL.revokeObjectURL(url); });

/* ====== Optional: Gist sync helpers ====== */
function note(msg){ byId('sync-status').textContent = msg; }
function saveSyncFields(){ GH_TOKEN = byId('gh-token').value.trim(); GH_GIST = byId('gh-gist').value.trim(); localStorage.setItem('cookbook.gh.token', GH_TOKEN); localStorage.setItem('cookbook.gh.gist', GH_GIST); }
async function ensureToken(){ saveSyncFields(); if(!GH_TOKEN){ note('Please enter a GitHub token with gist permission.'); throw new Error('no token'); } }
function recipesPayload(){ return JSON.stringify(RECIPES, null, 2); }
async function gistCreate(){ try{ saveSyncFields(); const res = await fetch('https://api.github.com/gists', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${GH_TOKEN}`, 'Accept':'application/vnd.github+json' }, body: JSON.stringify({ description:'Cookbook recipes', public:false, files:{ 'recipes.json': { content: recipesPayload() } } }) }); if(!res.ok){ note('Create failed'); return false; } const j = await res.json(); GH_GIST = j.id; localStorage.setItem('cookbook.gh.gist', GH_GIST); byId('gh-gist').value = GH_GIST; return true; } catch(e){ note('Network error creating gist'); return false; } }
async function gistSave(){ try{ saveSyncFields(); if(!GH_GIST){ const created = await gistCreate(); return created; } const res = await fetch(`https://api.github.com/gists/${GH_GIST}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${GH_TOKEN}`, 'Accept':'application/vnd.github+json' }, body: JSON.stringify({ files:{ 'recipes.json': { content: recipesPayload() } } }) }); if(!res.ok){ note('Save failed'); return false; } return true; } catch(e){ note('Network error saving gist'); return false; } }
async function gistLoad(){ try{ saveSyncFields(); if(!GH_GIST){ note('Enter a Gist ID first'); return null; } const res = await fetch(`https://api.github.com/gists/${GH_GIST}`, { headers:{ 'Authorization':`Bearer ${GH_TOKEN}`, 'Accept':'application/vnd.github+json' } }); if(!res.ok){ note('Load failed'); return null; } const j = await res.json(); const file = j.files && (j.files['recipes.json'] || Object.values(j.files)[0]); if(!file || !file.content){ note('recipes.json not found in gist'); return null; } const arr = JSON.parse(file.content); if(!Array.isArray(arr)){ note('Gist content is not an array'); return null; } return arr; } catch(e){ note('Network or parse error loading gist'); return null; } }
function mergeArraysByNewest(localArr, remoteArr){
  const map = new Map();
  const put = (r)=>{ const old = map.get(r.id); if(!old){ map.set(r.id,r); return; } const a = Date.parse(old.updatedAt||0), b = Date.parse(r.updatedAt||0); map.set(r.id, (b>a)? r : old); };
  localArr.forEach(put); remoteArr.forEach(put);
  return Array.from(map.values());
}
async function autoPush(){ if(!GH_TOKEN) return; const ok = await gistSave(); if(!ok){ /* noop */ } }
async function autoPullMerge(){ if(!GH_TOKEN || !GH_GIST) return; const remote = await gistLoad(); if(remote && Array.isArray(remote)){ RECIPES = mergeArraysByNewest(RECIPES, remote); persist(); renderTabs(); renderList(); renderDetail(); } }

/* ====== Events ====== */
$tabs.addEventListener('click',e=>{ const t=e.target.closest('.tab'); if(!t) return; TAB=t.dataset.tab; localStorage.setItem('cookbook.tab',TAB); SELECTED=''; localStorage.setItem('cookbook.sel',SELECTED); renderTabs(); renderList(); renderDetail(); });
byId('catSelect').addEventListener('change',e=>{ TAB=e.target.value; localStorage.setItem('cookbook.tab',TAB); SELECTED=''; localStorage.setItem('cookbook.sel',SELECTED); renderTabs(); renderList(); renderDetail(); });
$list.addEventListener('click',e=>{ const it=e.target.closest('.item'); if(!it) return; SELECTED=it.dataset.id; localStorage.setItem('cookbook.sel',SELECTED); renderList(); renderDetail(); });
byId('search').addEventListener('input',renderList);
byId('btn-add').addEventListener('click',()=>openEditor(null));
byId('btn-parse').addEventListener('click',()=>tryParse());
byId('btn-save').addEventListener('click',e=>{ e.preventDefault(); saveRecipe(); });

// Sync dialog open
byId('btn-sync').addEventListener('click',()=>{ byId('gh-token').value = GH_TOKEN; byId('gh-gist').value = GH_GIST; byId('sync-status').textContent=''; byId('sync').showModal(); });
// Sync dialog actions
byId('btn-gist-create').addEventListener('click',async()=>{ try{ await ensureToken(); const ok = await gistCreate(); note(ok? 'Created gist and pushed current recipes.' : 'Create failed.'); }catch{} });
byId('btn-gist-save').addEventListener('click',async()=>{ try{ await ensureToken(); const ok = await gistSave(); note(ok? 'Saved to gist.' : 'Save failed.'); }catch{} });
byId('btn-gist-load').addEventListener('click',async()=>{ try{ await ensureToken(); if(!GH_GIST){ return note('Add a Gist ID first or create a new one.'); } if(!confirm('Replace local recipes with the gist content? This cannot be undone.')) return; const data = await gistLoad(); if(data){ RECIPES = data; persist(); SELECTED=''; localStorage.setItem('cookbook.sel',''); renderTabs(); renderList(); renderDetail(); note('Loaded from gist.'); } }catch{} });
byId('btn-gist-merge').addEventListener('click',async()=>{ try{ await ensureToken(); const data = await gistLoad(); if(!data){ return note('Could not load from gist.'); } RECIPES = mergeArraysByNewest(RECIPES, data); persist(); renderTabs(); renderList(); renderDetail(); note('Merged gist → local (kept newest per recipe).'); }catch{} });
byId('btn-sync-signout').addEventListener('click',()=>{ localStorage.removeItem('cookbook.gh.token'); localStorage.removeItem('cookbook.gh.gist'); GH_TOKEN=''; GH_GIST=''; byId('gh-token').value=''; byId('gh-gist').value=''; note('This device is signed out of sync.'); });

/* ====== Init ====== */
renderTabs(); renderList(); renderDetail();
// Optional: auto-pull/merge from Gist (if configured)
autoPullMerge();

/* ====== Always fetch the latest recipes.json from GitHub on load ====== */
async function loadRecipesFromGitHub() {
  try {
    const url = GITHUB_JSON_URL + "?ts=" + Date.now(); // cache-buster
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) return;
    const data = await res.json();
    if (Array.isArray(data)) {
      RECIPES = data;
      persist();
      if (!SELECTED && RECIPES.length) {
        const first = RECIPES.find(r=>sameCat(r.category,TAB)) || RECIPES[0];
        if (first) { SELECTED = first.id; localStorage.setItem('cookbook.sel', SELECTED); }
      }
      renderTabs(); renderList(); renderDetail();
      // If any TikTok embeds appear after load, ensure script is present
      if (document.querySelector('.tiktok-embed')) ensureTikTokScript();
    }
  } catch (e) {
    console.warn("GitHub recipes.json fetch failed (using local data).", e);
  }
}
loadRecipesFromGitHub(); // always refresh from GitHub
</script>
</body>
</html>
